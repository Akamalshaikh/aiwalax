<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shaikh's AI - Enhanced</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: {
                            900: '#05080f',
                            800: '#0b0f19',
                            700: '#111827',
                            600: '#1f2937',
                            500: '#374151',
                        },
                        brand: {
                            500: '#6366f1', // Indigo
                            600: '#4f46e5',
                        }
                    },
                    animation: {
                        'slide-in': 'slideIn 0.3s ease-out forwards',
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                    },
                    keyframes: {
                        slideIn: {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(0)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #0b0f19;
            color: #e2e8f0;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Markdown Styles */
        .prose p { margin-bottom: 1em; line-height: 1.7; }
        .prose pre { 
            background: #111827; 
            padding: 1.25rem; 
            border-radius: 0.75rem; 
            overflow-x: auto; 
            margin: 1.5rem 0; 
            border: 1px solid #1f2937;
        }
        .prose code { 
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace; 
            background: #1f2937; 
            color: #e2e8f0;
            padding: 0.2rem 0.4rem; 
            border-radius: 0.25rem; 
            font-size: 0.875rem; 
        }
        .prose pre code { background: transparent; padding: 0; color: #e2e8f0; border: none; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; }
        .prose ol { list-style-type: decimal; padding-left: 1.5rem; margin-bottom: 1rem; }
        .prose h1, .prose h2, .prose h3 { font-weight: 700; color: #f8fafc; margin-top: 2rem; margin-bottom: 0.75rem; }
        .prose a { color: #818cf8; text-decoration: underline; text-underline-offset: 2px; }
        .prose strong { color: #fff; font-weight: 600; }

        /* Thought Process Styling */
        details.think-block {
            background: rgba(30, 41, 59, 0.4);
            border-left: 3px solid #6366f1;
            padding: 0.75rem 1rem;
            margin-bottom: 1.5rem;
            border-radius: 0 0.5rem 0.5rem 0;
            font-size: 0.9rem;
            color: #94a3b8;
        }
        details.think-block summary {
            cursor: pointer;
            font-weight: 500;
            color: #818cf8;
            outline: none;
            list-style: none; /* Hide default triangle */
            display: flex;
            align-items: center;
            gap: 8px;
        }
        details.think-block summary::before {
            content: '\f0eb'; /* FontAwesome bulb */
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
        }
        details.think-block[open] summary { margin-bottom: 0.75rem; border-bottom: 1px solid #334155; padding-bottom: 0.5rem; }

        /* Animations */
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-sm md:text-base">

    <!-- Mobile Overlay -->
    <div id="mobileOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-40 hidden md:hidden transition-opacity"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 w-72 bg-dark-900 border-r border-gray-800 flex flex-col z-50 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out md:relative shadow-2xl md:shadow-none">
        <!-- Sidebar Header -->
        <div class="p-4 flex items-center justify-between">
            <h2 class="font-bold text-lg tracking-tight text-white flex items-center gap-2">
                <i class="fa-solid fa-layer-group text-indigo-500"></i> History
            </h2>
            <!-- Close Button (Mobile Only) -->
            <button onclick="toggleSidebar()" class="md:hidden text-gray-400 hover:text-white p-2 rounded-lg hover:bg-gray-800 transition-colors">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
        </div>

        <!-- New Chat Button -->
        <div class="px-4 pb-4">
            <button onclick="startNewChat()" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-brand-600 hover:bg-brand-500 text-white rounded-xl transition-all shadow-lg shadow-indigo-500/20 font-medium active:scale-95">
                <i class="fa-solid fa-plus"></i> <span>New Chat</span>
            </button>
        </div>

        <!-- Search -->
        <div class="px-4 pb-2">
            <div class="relative group">
                <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-gray-500 group-focus-within:text-indigo-400 transition-colors"></i>
                <input type="text" id="historySearch" onkeyup="filterHistory()" placeholder="Search conversations..." class="w-full bg-dark-700 text-sm text-gray-300 rounded-lg py-2.5 pl-9 pr-3 border border-transparent focus:border-indigo-500/50 focus:bg-dark-600 focus:outline-none transition-all placeholder-gray-600">
            </div>
        </div>

        <!-- History List -->
        <div id="historyList" class="flex-1 overflow-y-auto px-2 space-y-1 py-2">
            <!-- Dynamic Content populated via JS -->
            <div class="text-center text-gray-600 mt-10 text-sm italic">No history yet</div>
        </div>

        <!-- User Profile -->
        <div class="p-4 border-t border-gray-800 bg-dark-900">
            <button class="flex items-center gap-3 w-full px-2 py-2 rounded-lg hover:bg-dark-700 transition-colors group">
                <div class="w-9 h-9 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center text-xs font-bold text-white shadow-inner">
                    SA
                </div>
                <div class="flex-1 text-left">
                    <div class="text-sm font-medium text-gray-200 group-hover:text-white">User Account</div>
                    <div class="text-xs text-gray-500">Pro Plan</div>
                </div>
                <i class="fa-solid fa-gear text-gray-600 group-hover:text-gray-400"></i>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative bg-dark-800 w-full">
        
        <!-- Header -->
        <header class="h-16 border-b border-gray-800/60 flex items-center justify-between px-4 md:px-6 bg-dark-800/80 backdrop-blur-md z-30 absolute top-0 w-full">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="md:hidden text-gray-400 hover:text-white p-1 rounded hover:bg-gray-800 transition-colors">
                    <i class="fa-solid fa-bars text-xl"></i>
                </button>
                <div class="flex items-center gap-2">
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400 font-bold text-lg md:text-xl">Shaikh's AI</span>
                </div>
                <div class="h-6 w-px bg-gray-700/50 mx-1 hidden sm:block"></div>
                
                <!-- Model Selector -->
                <div class="relative group">
                    <button id="modelDropdownBtn" class="flex items-center gap-2 text-xs md:text-sm text-gray-300 hover:text-white bg-dark-700 hover:bg-dark-600 px-3 py-1.5 rounded-full transition-all border border-gray-700 hover:border-gray-600">
                        <span id="currentModelDisplay" class="font-medium truncate max-w-[120px] md:max-w-none">claude-sonnet-4.5</span>
                        <i class="fa-solid fa-chevron-down text-[10px] text-gray-500"></i>
                    </button>
                    
                    <!-- Dropdown -->
                    <div id="modelDropdown" class="absolute top-full left-0 mt-2 w-64 bg-dark-700 border border-gray-600/50 rounded-xl shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 transform origin-top-left ring-1 ring-black/20">
                        <div class="p-1.5" id="modelListContainer">
                            <!-- Models injected via JS -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <button onclick="clearCurrentChat()" class="text-gray-400 hover:text-red-400 px-3 py-1.5 text-sm rounded-md hover:bg-red-500/10 transition-colors" title="Clear current messages">
                    <i class="fa-regular fa-trash-can"></i>
                </button>
            </div>
        </header>

        <!-- Chat Area -->
        <div id="chatContainer" class="flex-1 overflow-y-auto px-4 md:px-8 pt-20 pb-4 scroll-smooth">
            
            <!-- Empty State -->
            <div id="emptyState" class="min-h-[80vh] flex flex-col items-center justify-center text-center opacity-100 transition-opacity duration-300">
                <div class="w-20 h-20 bg-dark-700/50 rounded-3xl flex items-center justify-center mb-8 shadow-2xl shadow-indigo-500/5 border border-gray-800">
                    <i class="fa-solid fa-wand-magic-sparkles text-3xl text-indigo-400"></i>
                </div>
                <h1 class="text-2xl md:text-4xl font-bold text-white mb-4">How can I help you today?</h1>
                <p class="text-gray-400 max-w-md mb-10 text-sm md:text-base">Experience advanced AI models. Select a model from the top left and start building, creating, or researching.</p>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full max-w-2xl px-2">
                    <button onclick="setInput('Write a Python script to scrape a website')" class="p-5 rounded-2xl border border-gray-800 bg-dark-700/30 hover:bg-dark-700 hover:border-indigo-500/30 text-left transition-all group hover:-translate-y-1 hover:shadow-lg">
                        <div class="text-indigo-400 mb-3 text-xl"><i class="fa-brands fa-python"></i></div>
                        <div class="font-semibold text-gray-200 group-hover:text-indigo-300 mb-1">Python Scraper</div>
                        <div class="text-xs text-gray-500">Write code to extract data efficiently</div>
                    </button>
                    <button onclick="setInput('Explain quantum computing like I am 5')" class="p-5 rounded-2xl border border-gray-800 bg-dark-700/30 hover:bg-dark-700 hover:border-purple-500/30 text-left transition-all group hover:-translate-y-1 hover:shadow-lg">
                        <div class="text-purple-400 mb-3 text-xl"><i class="fa-solid fa-brain"></i></div>
                        <div class="font-semibold text-gray-200 group-hover:text-purple-300 mb-1">Explain Concepts</div>
                        <div class="text-xs text-gray-500">Simple breakdowns of complex topics</div>
                    </button>
                </div>
            </div>

            <!-- Messages List -->
            <div id="messagesList" class="max-w-3xl mx-auto space-y-8 pb-32"></div>
            
            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="hidden max-w-3xl mx-auto mt-4 mb-32 pl-12">
                <div class="inline-flex items-center gap-1 bg-dark-700 px-4 py-2 rounded-full border border-gray-600">
                    <span class="text-xs text-gray-400 font-medium mr-2">AI is thinking</span>
                    <div class="w-1.5 h-1.5 bg-indigo-400 rounded-full typing-dot"></div>
                    <div class="w-1.5 h-1.5 bg-indigo-400 rounded-full typing-dot"></div>
                    <div class="w-1.5 h-1.5 bg-indigo-400 rounded-full typing-dot"></div>
                </div>
            </div>
        </div>

        <!-- Input Area (Fixed Bottom) -->
        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-dark-800 via-dark-800 to-transparent pt-12 pb-6 px-4 md:px-8 z-20">
            <div class="max-w-3xl mx-auto relative">
                <div class="bg-dark-700/80 backdrop-blur-xl border border-gray-600/50 rounded-2xl shadow-2xl flex flex-col transition-all focus-within:border-indigo-500/70 focus-within:ring-2 focus-within:ring-indigo-500/20 focus-within:bg-dark-700">
                    <textarea 
                        id="userPrompt" 
                        rows="1" 
                        placeholder="Message Shaikh's AI..." 
                        class="w-full bg-transparent text-gray-200 placeholder-gray-500 px-5 py-4 focus:outline-none resize-none max-h-48 overflow-y-auto custom-scrollbar"
                        oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"
                        onkeydown="handleEnter(event)"
                    ></textarea>
                    
                    <div class="flex justify-between items-center px-3 pb-3">
                        <div class="flex items-center gap-1">
                            <button class="p-2 text-gray-400 hover:text-indigo-400 transition-colors rounded-lg hover:bg-gray-600/30" title="Attach file (Demo)">
                                <i class="fa-solid fa-paperclip"></i>
                            </button>
                            <button class="p-2 text-gray-400 hover:text-indigo-400 transition-colors rounded-lg hover:bg-gray-600/30" title="Voice input (Demo)">
                                <i class="fa-solid fa-microphone"></i>
                            </button>
                        </div>
                        <button onclick="sendMessage()" id="sendBtn" class="bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl px-5 py-2 text-sm font-semibold transition-all flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-indigo-500/20 hover:shadow-indigo-500/40">
                            Send <i class="fa-solid fa-paper-plane text-xs"></i>
                        </button>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <p class="text-[11px] text-gray-500 font-medium">AI can make mistakes. Please verify important information.</p>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- Configuration ---
        const AVAILABLE_MODELS = [
            "claude-sonnet-4.5", "gpt-5", "grok-4", "gemini-2.5-pro", 
            "kyvex", "kyvex-labs-deep-research", "gemini-imagen-4"
        ];
        
        let currentModel = AVAILABLE_MODELS[0];
        const apiBaseUrl = "http://64.227.155.90:9100/chat/get";
        
        // Chat History Data Structure
        // { id: timestamp, title: string, model: string, messages: [{role: 'user'|'ai', content: string}] }
        let chatHistory = [];
        let currentChatId = null;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initModelDropdown();
            loadHistoryFromStorage();
            
            // Start a new chat session automatically if no history or just default
            if (!currentChatId) {
                startNewChat(false); // false = don't UI refresh yet
            }
            
            document.getElementById('userPrompt').focus();
        });

        // --- UI Logic: Sidebar & Layout ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            
            const isClosed = sidebar.classList.contains('-translate-x-full');
            
            if (isClosed) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                setTimeout(() => {
                   if(sidebar.classList.contains('-translate-x-full')) overlay.classList.add('hidden'); 
                }, 300); // Wait for animation
            }
        }

        function initModelDropdown() {
            const container = document.getElementById('modelListContainer');
            const display = document.getElementById('currentModelDisplay');
            
            container.innerHTML = '';
            
            AVAILABLE_MODELS.forEach(model => {
                const btn = document.createElement('button');
                btn.className = `w-full text-left px-3 py-2 text-sm rounded-lg transition-colors flex items-center gap-2 mb-1 ${model === currentModel ? 'bg-indigo-500/20 text-indigo-300 border border-indigo-500/30' : 'text-gray-300 hover:bg-dark-600'}`;
                btn.onclick = () => selectModel(model);
                btn.innerHTML = `
                    <i class="fa-solid fa-microchip text-xs ${model === currentModel ? 'text-indigo-400' : 'text-gray-500'}"></i>
                    ${model}
                `;
                container.appendChild(btn);
            });

            display.textContent = currentModel;
        }

        function selectModel(model) {
            currentModel = model;
            initModelDropdown();
        }

        function setInput(text) {
            const input = document.getElementById('userPrompt');
            input.value = text;
            input.focus();
            input.style.height = ''; 
            input.style.height = input.scrollHeight + 'px';
        }

        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function toggleEmptyState(visible) {
            const el = document.getElementById('emptyState');
            if (visible) {
                el.classList.remove('hidden');
                el.style.display = 'flex';
            } else {
                el.classList.add('hidden');
                el.style.display = 'none';
            }
        }

        // --- Core Logic: Chat History Management ---

        function loadHistoryFromStorage() {
            const stored = localStorage.getItem('shaikhs_ai_history');
            if (stored) {
                chatHistory = JSON.parse(stored);
                renderHistorySidebar();
            }
        }

        function saveHistoryToStorage() {
            localStorage.setItem('shaikhs_ai_history', JSON.stringify(chatHistory));
            renderHistorySidebar();
        }

        function startNewChat(render = true) {
            currentChatId = Date.now();
            // Create empty session but don't add to list until first message
            if (render) {
                document.getElementById('messagesList').innerHTML = '';
                toggleEmptyState(true);
                // On mobile, close sidebar after selecting new chat
                if (window.innerWidth < 768) toggleSidebar();
                document.getElementById('userPrompt').focus();
            }
        }

        function getCurrentChat() {
            return chatHistory.find(c => c.id === currentChatId);
        }

        function addToCurrentChat(role, content) {
            let chat = getCurrentChat();
            
            // If this is the first message of a new session
            if (!chat) {
                chat = {
                    id: currentChatId,
                    title: content.length > 30 ? content.substring(0, 30) + '...' : content,
                    timestamp: Date.now(),
                    model: currentModel,
                    messages: []
                };
                chatHistory.unshift(chat); // Add to top
            }

            chat.messages.push({ role, content, timestamp: Date.now() });
            
            // Update timestamp of chat to move it to top
            chat.timestamp = Date.now();
            chatHistory.sort((a, b) => b.timestamp - a.timestamp);
            
            saveHistoryToStorage();
        }

        function deleteChat(e, id) {
            e.stopPropagation(); // Prevent loading the chat
            if(confirm('Delete this conversation?')) {
                chatHistory = chatHistory.filter(c => c.id !== id);
                saveHistoryToStorage();
                
                if (currentChatId === id) {
                    startNewChat();
                }
            }
        }

        function loadChat(id) {
            currentChatId = id;
            const chat = getCurrentChat();
            if (!chat) return;

            const list = document.getElementById('messagesList');
            list.innerHTML = '';
            toggleEmptyState(false);

            chat.messages.forEach(msg => {
                appendMessageToUI(msg.role, msg.content, false); // false = no animation for history load
            });

            // On mobile, close sidebar
            if (window.innerWidth < 768) {
                const sidebar = document.getElementById('sidebar');
                if (!sidebar.classList.contains('-translate-x-full')) toggleSidebar();
            }
        }

        function renderHistorySidebar() {
            const list = document.getElementById('historyList');
            const search = document.getElementById('historySearch').value.toLowerCase();
            
            list.innerHTML = '';

            const filtered = chatHistory.filter(c => c.title.toLowerCase().includes(search));

            if (filtered.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-600 mt-4 text-xs">No conversations found</div>';
                return;
            }

            // Group by dates (simple version: just list them)
            filtered.forEach(chat => {
                const btn = document.createElement('div');
                const isActive = chat.id === currentChatId;
                
                btn.className = `group w-full flex items-center gap-3 px-3 py-3 rounded-xl cursor-pointer transition-all mb-1 border border-transparent ${isActive ? 'bg-dark-700 border-gray-700' : 'hover:bg-dark-700/50 hover:border-gray-800'}`;
                btn.onclick = () => loadChat(chat.id);
                
                btn.innerHTML = `
                    <i class="fa-regular fa-message ${isActive ? 'text-indigo-400' : 'text-gray-500'}"></i>
                    <div class="flex-1 overflow-hidden">
                        <div class="text-sm font-medium truncate ${isActive ? 'text-gray-200' : 'text-gray-400 group-hover:text-gray-300'}">${escapeHtml(chat.title)}</div>
                        <div class="text-[10px] text-gray-600 truncate">${new Date(chat.timestamp).toLocaleDateString()}</div>
                    </div>
                    <button onclick="deleteChat(event, ${chat.id})" class="opacity-0 group-hover:opacity-100 text-gray-600 hover:text-red-400 p-1 transition-opacity">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                `;
                list.appendChild(btn);
            });
        }

        function filterHistory() {
            renderHistorySidebar();
        }

        function clearCurrentChat() {
            document.getElementById('messagesList').innerHTML = '';
            toggleEmptyState(true);
            // Technically keeps the ID, but visually clears. 
            // Better UX: start brand new
            startNewChat(); 
        }

        // --- Rendering Logic ---

        function appendMessageToUI(role, content, animate = true) {
            toggleEmptyState(false);
            const messagesList = document.getElementById('messagesList');
            const msgDiv = document.createElement('div');
            
            const isUser = role === 'user';
            
            msgDiv.className = `flex gap-4 md:gap-6 ${isUser ? 'flex-row-reverse' : 'flex-row'} ${animate ? 'animate-fade-in' : ''}`;
            
            const avatar = isUser 
                ? `<div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center flex-shrink-0 shadow-lg text-white font-bold text-xs">YOU</div>`
                : `<div class="w-10 h-10 rounded-xl bg-dark-700 flex items-center justify-center flex-shrink-0 border border-gray-700 shadow-lg"><i class="fa-solid fa-robot text-indigo-400 text-lg"></i></div>`;

            let contentHtml = '';
            
            if (isUser) {
                contentHtml = `
                    <div class="max-w-[85%] md:max-w-[75%]">
                        <div class="bg-indigo-600 text-white px-5 py-3.5 rounded-2xl rounded-tr-none shadow-md text-sm md:text-base leading-relaxed">
                            ${escapeHtml(content)}
                        </div>
                    </div>`;
            } else {
                const processedContent = processThinkingTags(content);
                const markedContent = marked.parse(processedContent);
                contentHtml = `
                    <div class="max-w-full overflow-hidden w-full">
                        <div class="prose prose-invert prose-sm md:prose-base max-w-none text-gray-300 leading-7">
                            ${markedContent}
                        </div>
                    </div>`;
            }

            msgDiv.innerHTML = `${avatar}${contentHtml}`;
            messagesList.appendChild(msgDiv);
            
            // Scroll logic
            const container = document.getElementById('chatContainer');
            container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
        }

        // --- Helpers ---

        function processThinkingTags(text) {
            let processed = text.replace(/<think>([\s\S]*?)<\/think>/gi, (match, content) => {
                return `<details class="think-block"><summary>Thought Process</summary>${content.trim()}</details>`;
            });
            processed = processed.replace(/\\u003Cthink\\u003E([\s\S]*?)\\u003C\/think\\u003E/gi, (match, content) => {
                 return `<details class="think-block"><summary>Thought Process</summary>${content.trim()}</details>`;
            });
            return processed;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // --- Networking ---
        async function fetchWithFallback(targetUrl) {
            const strategies = [
                { name: "Direct", fn: async () => {
                    const controller = new AbortController();
                    const id = setTimeout(() => controller.abort(), 2000);
                    const res = await fetch(targetUrl, { signal: controller.signal });
                    clearTimeout(id);
                    return res;
                }},
                { name: "CorsProxy.io", fn: async () => fetch(`https://corsproxy.io/?` + encodeURIComponent(targetUrl)) },
                { name: "AllOrigins", fn: async () => fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(targetUrl)}`) },
                { name: "CodeTabs", fn: async () => fetch(`https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(targetUrl)}`) }
            ];

            for (const strategy of strategies) {
                try {
                    const res = await strategy.fn();
                    if (res.ok) return res;
                } catch (e) { console.warn(`${strategy.name} failed`); }
            }
            throw new Error("Unable to connect to server.");
        }

        async function sendMessage() {
            const input = document.getElementById('userPrompt');
            const prompt = input.value.trim();
            
            if (!prompt) return;

            input.value = '';
            input.style.height = 'auto';

            // UI & Storage: Add User Message
            appendMessageToUI('user', prompt);
            addToCurrentChat('user', prompt);

            const loading = document.getElementById('loadingIndicator');
            loading.classList.remove('hidden');
            document.getElementById('sendBtn').disabled = true;

            // Scroll to bottom
            const container = document.getElementById('chatContainer');
            container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });

            try {
                const targetUrl = `${apiBaseUrl}?prompt=${encodeURIComponent(prompt)}&model=${currentModel}`;
                const response = await fetchWithFallback(targetUrl);
                const data = await response.json();
                
                const aiContent = (data && data.response) ? data.response : "_Error: Empty response_";
                
                appendMessageToUI('ai', aiContent);
                addToCurrentChat('ai', aiContent);

            } catch (error) {
                let errorMsg = `**Connection Failed**: ${error.message}.`;
                if (window.location.protocol === 'https:' && apiBaseUrl.startsWith('http:')) {
                    errorMsg += `\n\n*Note: Mixed Content Block (HTTPS to HTTP). Please download and run locally.*`;
                }
                appendMessageToUI('ai', errorMsg);
                addToCurrentChat('ai', errorMsg);
                
                // Demo Fallback
                setTimeout(() => {
                    const demoMsg = "Since I can't reach the backend in this environment, I'm simulating a response.\n\nHere is a code example:\n```javascript\nconsole.log('Demo Mode');\n```";
                    appendMessageToUI('ai', demoMsg);
                    addToCurrentChat('ai', demoMsg);
                }, 1000);

            } finally {
                loading.classList.add('hidden');
                document.getElementById('sendBtn').disabled = false;
                setTimeout(() => document.getElementById('userPrompt').focus(), 100);
            }
        }
    </script>
</body>
</html>
