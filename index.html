<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shaikh's AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #09090b; /* Zinc 950 */
            color: #e4e4e7; /* Zinc 200 */
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #27272a; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #3f3f46; }

        /* Markdown Styles within Chat */
        .prose { font-size: 0.95rem; line-height: 1.7; }
        .prose p { margin-bottom: 0.75em; }
        .prose pre { background: #18181b; border: 1px solid #27272a; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin: 1rem 0; }
        .prose code { font-family: 'JetBrains Mono', monospace; background: #27272a; padding: 0.2rem 0.4rem; border-radius: 0.25rem; font-size: 0.85rem; color: #e4e4e7; }
        .prose pre code { background: transparent; padding: 0; color: #e4e4e7; border: none; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; color: #d4d4d8; }
        .prose ol { list-style-type: decimal; padding-left: 1.5rem; margin-bottom: 1rem; color: #d4d4d8; }
        .prose h1, .prose h2, .prose h3 { font-weight: 600; color: #fafafa; margin-top: 1.5rem; margin-bottom: 0.75rem; }
        .prose strong { color: #fff; font-weight: 600; }
        .prose a { color: #818cf8; text-decoration: underline; }

        /* Thought Process Styling */
        details.think-block { background: #18181b; border-left: 3px solid #6366f1; padding: 0.75rem 1rem; margin-bottom: 1.25rem; border-radius: 0.375rem; font-size: 0.9rem; color: #a1a1aa; }
        details.think-block summary { cursor: pointer; font-weight: 500; color: #818cf8; user-select: none; outline: none; }
        details.think-block[open] summary { margin-bottom: 0.5rem; border-bottom: 1px solid #27272a; padding-bottom: 0.5rem; }

        /* Animations */
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        /* Sidebar Transition */
        /* Fixed: Adjusted transition to handle width changes smoothly */
        .sidebar-transition {
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), padding 0.3s ease;
        }
        
        /* Mobile Overlay */
        .mobile-overlay { background: rgba(0,0,0,0.6); backdrop-filter: blur(2px); }
    </style>
</head>
<body class="flex h-screen overflow-hidden selection:bg-indigo-500/30">

    <div id="mobileOverlay" onclick="toggleSidebar()" class="fixed inset-0 z-20 mobile-overlay hidden opacity-0 transition-opacity duration-300 md:hidden"></div>

    <aside id="sidebar" class="fixed md:relative inset-y-0 left-0 z-30 flex flex-col h-full bg-[#0c0c0e] border-r border-white/5 shadow-2xl md:shadow-none whitespace-nowrap overflow-hidden sidebar-transition w-72 transform -translate-x-full md:translate-x-0">
        
        <div class="p-4 flex items-center justify-between border-b border-white/5 min-h-[65px]">
            <span class="text-sm font-semibold text-gray-400 uppercase tracking-wider pl-2">History</span>
            <button onclick="toggleSidebar()" class="md:hidden text-gray-400 hover:text-white p-2">
                <i class="fa-solid fa-xmark text-lg"></i>
            </button>
            <button onclick="toggleSidebar()" class="hidden md:block text-gray-500 hover:text-white p-1.5 rounded-md hover:bg-white/5 transition-colors" title="Close Sidebar">
                <i class="fa-solid fa-angles-left"></i>
            </button>
        </div>

        <div class="p-4 pb-2">
            <button onclick="startNewChat()" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-white/5 hover:bg-white/10 text-white rounded-xl transition-all border border-white/5 hover:border-indigo-500/50 group">
                <i class="fa-solid fa-plus text-indigo-400 group-hover:text-indigo-300"></i>
                <span class="font-medium text-sm">New Chat</span>
            </button>
        </div>

        <div class="px-4 py-2">
            <div class="relative group">
                <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-gray-600 group-focus-within:text-indigo-400 transition-colors text-xs"></i>
                <input type="text" id="searchInput" onkeyup="filterHistory()" placeholder="Search chats..." class="w-full bg-[#18181b] text-sm text-gray-300 rounded-lg py-2 pl-9 pr-3 border border-transparent focus:border-indigo-500/50 focus:bg-[#18181b] focus:outline-none transition-all placeholder-gray-600">
            </div>
        </div>

        <div id="historyList" class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar">
            </div>

        <div class="p-4 border-t border-white/5 bg-[#0c0c0e]">
            <div class="flex items-center gap-3 w-full px-2 py-2 rounded-xl hover:bg-white/5 transition-colors cursor-pointer">
                <div class="w-9 h-9 rounded-full bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center text-xs font-bold text-white shadow-lg shadow-indigo-900/20 flex-shrink-0">
                    SA
                </div>
                <div class="flex-1 min-w-0">
                    <div class="text-sm font-medium text-gray-200 truncate">User Account</div>
                    <div class="text-xs text-gray-500 truncate">Pro Plan Active</div>
                </div>
                <button onclick="clearAllHistory()" class="text-gray-500 hover:text-red-400 p-1.5" title="Clear All History">
                    <i class="fa-regular fa-trash-can"></i>
                </button>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative bg-[#09090b] w-full min-w-0 transition-all duration-300">
        
        <header class="h-16 border-b border-white/5 flex items-center justify-between px-4 md:px-6 bg-[#09090b]/80 backdrop-blur-xl z-10 sticky top-0">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="text-gray-400 hover:text-white p-2 -ml-2 rounded-lg hover:bg-white/5 transition-colors">
                    <i class="fa-solid fa-bars-staggered text-lg"></i>
                </button>
                
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-indigo-500/10 rounded-lg flex items-center justify-center border border-indigo-500/20">
                        <i class="fa-solid fa-robot text-indigo-400"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-sm md:text-base text-transparent bg-clip-text bg-gradient-to-r from-indigo-300 to-purple-300">Shaikh's AI</h1>
                        <p class="text-[10px] text-gray-500 leading-none hidden sm:block">Advanced reasoning engine</p>
                    </div>
                </div>

                <div class="h-6 w-px bg-white/10 mx-2 hidden sm:block"></div>
                
                <div class="relative group hidden sm:block">
                    <button id="modelDropdownBtn" class="flex items-center gap-2 text-xs font-medium text-gray-400 hover:text-white bg-white/5 hover:bg-white/10 px-3 py-1.5 rounded-full transition-all border border-white/5">
                        <span id="currentModelDisplay">claude-sonnet-4.5</span>
                        <i class="fa-solid fa-chevron-down text-[10px] opacity-50"></i>
                    </button>
                    <div id="modelDropdown" class="absolute top-full left-0 mt-2 w-56 bg-[#18181b] border border-white/10 rounded-xl shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 p-1">
                        </div>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <button class="text-gray-400 hover:text-indigo-400 p-2 rounded-lg hover:bg-indigo-500/10 transition-colors" title="Export Chat">
                    <i class="fa-solid fa-download"></i>
                </button>
                <button class="text-gray-400 hover:text-white p-2 rounded-lg hover:bg-white/5 transition-colors md:hidden">
                    <i class="fa-solid fa-ellipsis-vertical"></i>
                </button>
            </div>
        </header>

        <div id="chatContainer" class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth">
            
            <div id="emptyState" class="h-full flex flex-col items-center justify-center text-center pb-20 max-w-2xl mx-auto animate-fade-in">
                <div class="w-20 h-20 bg-gradient-to-tr from-indigo-500/20 to-purple-500/20 rounded-3xl flex items-center justify-center mb-8 border border-white/5 shadow-2xl shadow-indigo-900/20">
                    <i class="fa-solid fa-wand-magic-sparkles text-3xl text-indigo-400"></i>
                </div>
                <h2 class="text-2xl md:text-3xl font-bold text-white mb-3">How can I help you today?</h2>
                <p class="text-gray-500 mb-8 max-w-md">I'm ready to assist with coding, analysis, or creative writing. Select a model to begin.</p>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 w-full">
                    <button onclick="setInput('Create a Python script for data analysis')" class="p-4 rounded-xl border border-white/5 bg-white/[0.02] hover:bg-white/[0.05] hover:border-indigo-500/30 text-left transition-all group">
                        <div class="text-indigo-400 mb-2 group-hover:scale-110 transition-transform origin-left"><i class="fa-brands fa-python"></i></div>
                        <div class="text-sm font-medium text-gray-200">Python Script</div>
                        <div class="text-xs text-gray-500 mt-1">Data analysis template</div>
                    </button>
                    <button onclick="setInput('Explain how Neural Networks work')" class="p-4 rounded-xl border border-white/5 bg-white/[0.02] hover:bg-white/[0.05] hover:border-purple-500/30 text-left transition-all group">
                        <div class="text-purple-400 mb-2 group-hover:scale-110 transition-transform origin-left"><i class="fa-solid fa-brain"></i></div>
                        <div class="text-sm font-medium text-gray-200">Concept Explainer</div>
                        <div class="text-xs text-gray-500 mt-1">Deep learning basics</div>
                    </button>
                </div>
            </div>

            <div id="messagesList" class="max-w-3xl mx-auto space-y-8 pb-10"></div>
            
            <div id="loadingIndicator" class="hidden max-w-3xl mx-auto mt-4 pl-12 md:pl-0">
                <div class="flex items-start gap-4">
                    <div class="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center flex-shrink-0 mt-1 shadow-lg shadow-indigo-500/20">
                        <i class="fa-solid fa-robot text-xs text-white"></i>
                    </div>
                    <div class="bg-[#18181b] rounded-2xl rounded-tl-none px-4 py-3 border border-white/5">
                        <div class="flex items-center gap-1.5 h-5">
                            <div class="w-1.5 h-1.5 bg-indigo-400 rounded-full typing-dot"></div>
                            <div class="w-1.5 h-1.5 bg-indigo-400 rounded-full typing-dot"></div>
                            <div class="w-1.5 h-1.5 bg-indigo-400 rounded-full typing-dot"></div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>

        <!-- Input Area (Fixed Mobile Layout Issue) -->
        <div class="flex-shrink-0 bg-[#09090b] border-t border-white/5 pt-4 pb-6 px-4">
            <div class="max-w-3xl mx-auto relative">
                <div class="bg-[#18181b] border border-white/10 rounded-2xl shadow-2xl flex flex-col transition-all focus-within:border-indigo-500/50 focus-within:ring-1 focus-within:ring-indigo-500/20">
                    <textarea 
                        id="userPrompt" 
                        rows="1" 
                        placeholder="Message Shaikh's AI..." 
                        class="w-full bg-transparent text-gray-200 placeholder-gray-500 px-5 py-4 focus:outline-none resize-none max-h-48 overflow-y-auto rounded-t-2xl custom-scrollbar"
                        oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"
                        onkeydown="handleEnter(event)"
                    ></textarea>
                    
                    <div class="flex justify-between items-center px-3 pb-3 pt-1">
                        <div class="flex items-center gap-1">
                            <button class="p-2 text-gray-500 hover:text-indigo-400 transition-colors rounded-lg hover:bg-white/5" title="Attach file">
                                <i class="fa-solid fa-paperclip"></i>
                            </button>
                            <button class="p-2 text-gray-500 hover:text-indigo-400 transition-colors rounded-lg hover:bg-white/5" title="Voice input">
                                <i class="fa-solid fa-microphone"></i>
                            </button>
                        </div>
                        <div class="flex items-center gap-3 mt-2">
                            <span class="text-[10px] text-gray-600 hidden sm:block">Return to send</span>
                            <button onclick="sendMessage()" id="sendBtn" class="bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl px-4 py-2 text-sm font-medium transition-all shadow-lg shadow-indigo-500/20 hover:shadow-indigo-500/30 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                <!-- Changed icon to Up Arrow -->
                                <i class="fa-solid fa-arrow-up"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="text-center">
                    <p class="text-[10px] text-gray-600 mt-2">AI can make mistakes. Please verify important information.</p>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- Configuration ---
        const AVAILABLE_MODELS = [
            "claude-sonnet-4.5", "gpt-5", "grok-4", "gemini-2.5-pro", 
            "kyvex", "kyvex-labs-deep-research", "gemini-imagen-4"
        ];
        let currentModel = AVAILABLE_MODELS[0];
        const apiBaseUrl = "http://64.227.155.90:9100/chat/get";
        
        // State for Chat History
        let chatHistory = JSON.parse(localStorage.getItem('shaikhs_ai_chats')) || {};
        let currentSessionId = null;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initModelDropdown();
            renderHistoryList();
            startNewChat(); // Default start state
            
            // Check mobile on load
            if (window.innerWidth < 768) {
                // Ensure correct mobile initial state
                document.getElementById('sidebar').classList.add('-translate-x-full');
            }
        });

        // --- FIXED SIDEBAR LOGIC ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            const isMobile = window.innerWidth < 768;

            if (isMobile) {
                // Mobile: Toggle Translate and Overlay
                if (sidebar.classList.contains('-translate-x-full')) {
                    // Open
                    sidebar.classList.remove('-translate-x-full');
                    overlay.classList.remove('hidden');
                    // Small timeout to allow display:block to apply before opacity transition
                    setTimeout(() => overlay.classList.remove('opacity-0'), 10);
                } else {
                    // Close
                    sidebar.classList.add('-translate-x-full');
                    overlay.classList.add('opacity-0');
                    setTimeout(() => overlay.classList.add('hidden'), 300);
                }
            } else {
                // Desktop: Toggle Width and Padding
                // We use Tailwind classes instead of inline styles for smoother animation
                
                if (sidebar.classList.contains('w-72')) {
                    // Collapse
                    sidebar.classList.remove('w-72');
                    sidebar.classList.add('w-0');
                    sidebar.classList.add('p-0'); // Remove padding
                    sidebar.classList.add('border-none'); // Hide border
                } else {
                    // Expand
                    sidebar.classList.remove('w-0');
                    sidebar.classList.remove('p-0');
                    sidebar.classList.remove('border-none');
                    sidebar.classList.add('w-72');
                }
            }
        }

        // --- History & Persistence Logic ---

        function generateId() {
            return 'chat_' + Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function startNewChat() {
            currentSessionId = generateId();
            chatHistory[currentSessionId] = {
                title: 'New Chat',
                timestamp: Date.now(),
                messages: []
            };
            document.getElementById('messagesList').innerHTML = '';
            toggleEmptyState(true);
            document.getElementById('userPrompt').value = '';
            document.getElementById('userPrompt').focus();
            renderHistoryList();
        }

        function saveMessageToHistory(role, content) {
            if (!chatHistory[currentSessionId]) {
                chatHistory[currentSessionId] = {
                    title: content.substring(0, 30) + (content.length > 30 ? '...' : ''),
                    timestamp: Date.now(),
                    messages: []
                };
            }
            if (role === 'user' && chatHistory[currentSessionId].messages.length === 0) {
                chatHistory[currentSessionId].title = content.substring(0, 30) + (content.length > 30 ? '...' : '');
            }
            chatHistory[currentSessionId].messages.push({ role, content, timestamp: Date.now() });
            localStorage.setItem('shaikhs_ai_chats', JSON.stringify(chatHistory));
            renderHistoryList();
        }

        function loadSession(id) {
            if (!chatHistory[id]) return;
            currentSessionId = id;
            const session = chatHistory[id];
            document.getElementById('messagesList').innerHTML = '';
            toggleEmptyState(false);
            session.messages.forEach(msg => {
                appendMessageToUI(msg.role, msg.content, false);
            });
            if (window.innerWidth < 768) {
                // Close sidebar on mobile selection
                const sidebar = document.getElementById('sidebar');
                if (!sidebar.classList.contains('-translate-x-full')) {
                    toggleSidebar();
                }
            }
            renderHistoryList();
        }

        function clearAllHistory() {
            if(confirm("Are you sure you want to delete all chat history?")) {
                chatHistory = {};
                localStorage.removeItem('shaikhs_ai_chats');
                startNewChat();
            }
        }

        function renderHistoryList() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            const sessions = Object.entries(chatHistory).sort(([,a], [,b]) => b.timestamp - a.timestamp);
            
            if (sessions.length === 0) {
                list.innerHTML = '<div class="text-xs text-gray-600 text-center py-4">No history yet</div>';
                return;
            }

            sessions.forEach(([id, session]) => {
                if (session.messages.length === 0 && id !== currentSessionId) return;

                const btn = document.createElement('button');
                const isActive = id === currentSessionId;
                
                btn.className = `w-full text-left px-3 py-3 rounded-xl mb-1 text-sm truncate transition-all flex items-center gap-3 group relative ${
                    isActive ? 'bg-indigo-500/10 text-indigo-300 border border-indigo-500/20' : 'text-gray-400 hover:bg-white/5 hover:text-gray-200 border border-transparent'
                }`;
                
                btn.onclick = () => loadSession(id);
                const deleteBtn = `<span onclick="deleteSession('${id}', event)" class="absolute right-2 opacity-0 group-hover:opacity-100 p-1 hover:text-red-400 transition-opacity"><i class="fa-solid fa-xmark"></i></span>`;

                btn.innerHTML = `
                    <i class="fa-regular fa-message text-xs ${isActive ? 'text-indigo-400' : 'text-gray-600'}"></i>
                    <span class="truncate pr-4">${escapeHtml(session.title || 'New Chat')}</span>
                    ${deleteBtn}
                `;
                list.appendChild(btn);
            });
        }
        
        function deleteSession(id, event) {
            event.stopPropagation();
            delete chatHistory[id];
            localStorage.setItem('shaikhs_ai_chats', JSON.stringify(chatHistory));
            if (id === currentSessionId) {
                startNewChat();
            } else {
                renderHistoryList();
            }
        }

        function filterHistory() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const list = document.getElementById('historyList');
            const buttons = list.getElementsByTagName('button');
            for (let btn of buttons) {
                const text = btn.textContent.toLowerCase();
                btn.style.display = text.includes(query) ? "flex" : "none";
            }
        }


        // --- UI Logic ---
        function initModelDropdown() {
            const container = document.getElementById('modelDropdown');
            const display = document.getElementById('currentModelDisplay');
            container.innerHTML = '';
            AVAILABLE_MODELS.forEach(model => {
                const btn = document.createElement('button');
                btn.className = `w-full text-left px-3 py-2 text-xs rounded-lg transition-colors flex items-center gap-2 ${model === currentModel ? 'bg-indigo-500/20 text-indigo-300' : 'text-gray-300 hover:bg-white/5'}`;
                btn.onclick = () => { currentModel = model; display.textContent = model; initModelDropdown(); };
                btn.innerHTML = `${model} ${model === currentModel ? '<i class="fa-solid fa-check ml-auto text-indigo-400"></i>' : ''}`;
                container.appendChild(btn);
            });
        }

        function setInput(text) {
            const input = document.getElementById('userPrompt');
            input.value = text;
            input.focus();
            input.style.height = ''; 
            input.style.height = input.scrollHeight + 'px';
        }

        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function toggleEmptyState(visible) {
            const el = document.getElementById('emptyState');
            el.style.display = visible ? 'flex' : 'none';
        }

        // --- Message Handling ---

        function appendMessageToUI(role, content, save = true) {
            toggleEmptyState(false);
            const messagesList = document.getElementById('messagesList');
            const msgDiv = document.createElement('div');
            const isUser = role === 'user';
            
            msgDiv.className = `flex gap-4 md:gap-6 ${isUser ? 'flex-row-reverse' : 'flex-row'} animate-fade-in group`;
            
            const avatar = isUser 
                ? `<div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center flex-shrink-0 border border-gray-600 shadow-md"><i class="fa-solid fa-user text-xs text-gray-300"></i></div>`
                : `<div class="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center flex-shrink-0 shadow-lg shadow-indigo-500/20"><i class="fa-solid fa-robot text-xs text-white"></i></div>`;

            let contentHtml = '';
            
            if (isUser) {
                contentHtml = `<div class="bg-[#27272a] text-gray-100 px-5 py-3.5 rounded-3xl rounded-tr-none max-w-[90%] md:max-w-[80%] border border-white/5 shadow-sm leading-relaxed">${escapeHtml(content)}</div>`;
            } else {
                const processedContent = processThinkingTags(content);
                const markedContent = marked.parse(processedContent);
                contentHtml = `
                    <div class="flex-1 min-w-0">
                        <div class="prose prose-invert prose-sm max-w-none text-gray-300 leading-7">
                            ${markedContent}
                        </div>
                        <div class="flex gap-2 mt-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button class="text-gray-500 hover:text-gray-300 text-xs p-1" onclick="navigator.clipboard.writeText(this.parentElement.previousElementSibling.innerText)"><i class="fa-regular fa-copy"></i> Copy</button>
                            <button class="text-gray-500 hover:text-gray-300 text-xs p-1"><i class="fa-solid fa-arrows-rotate"></i> Regenerate</button>
                        </div>
                    </div>
                `;
            }

            msgDiv.innerHTML = `${avatar}${contentHtml}`;
            messagesList.appendChild(msgDiv);
            const container = document.getElementById('chatContainer');
            container.scrollTop = container.scrollHeight;

            if (save) {
                saveMessageToHistory(role, content);
            }
        }

        function processThinkingTags(text) {
            let processed = text.replace(/<think>([\s\S]*?)<\/think>/gi, (match, content) => {
                return `<details class="think-block"><summary>Thought Process</summary>${content.trim()}</details>`;
            });
            processed = processed.replace(/\\u003Cthink\\u003E([\s\S]*?)\\u003C\/think\\u003E/gi, (match, content) => {
                 return `<details class="think-block"><summary>Thought Process</summary>${content.trim()}</details>`;
            });
            return processed;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // --- Fetch Logic (FIXED) ---
        async function fetchWithFallback(targetUrl) {
            const strategies = [
                { name: "Direct", fn: async () => { 
                    const controller = new AbortController();
                    // FIX: Increased timeout from 2000ms to 120000ms (2 minutes)
                    const id = setTimeout(() => controller.abort(), 120000000000000000);
                    try {
                        const res = await fetch(targetUrl, { signal: controller.signal });
                        clearTimeout(id);
                        return res; 
                    } catch(e) {
                        clearTimeout(id);
                        throw e;
                    }
                }},
                // Proxies to bypass Mixed Content / CORS
                { name: "CorsProxy.io", fn: async () => fetch(`https://corsproxy.io/?` + encodeURIComponent(targetUrl)) },
                { name: "AllOrigins", fn: async () => fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(targetUrl)}`) },
                { name: "CodeTabs", fn: async () => fetch(`https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(targetUrl)}`) }
            ];

            for (const strategy of strategies) {
                try {
                    // console.log(`Trying strategy: ${strategy.name}`); // Debug
                    const res = await strategy.fn();
                    if (res.ok) return res;
                } catch (e) { 
                    // console.warn(`${strategy.name} failed.`, e); 
                }
            }
            throw new Error("Unable to connect to server. If you are on HTTPS, ensure Mixed Content is allowed or use the Proxies automatically.");
        }

        async function sendMessage() {
            const input = document.getElementById('userPrompt');
            const prompt = input.value.trim();
            if (!prompt) return;

            input.value = '';
            input.style.height = 'auto';

            appendMessageToUI('user', prompt);
            
            const loading = document.getElementById('loadingIndicator');
            loading.classList.remove('hidden');
            document.getElementById('sendBtn').disabled = true;

            try {
                // Encode properly for GET request
                const targetUrl = `${apiBaseUrl}?prompt=${encodeURIComponent(prompt)}&model=${currentModel}`;
                const response = await fetchWithFallback(targetUrl);
                const data = await response.json();
                
                if (data && data.response) {
                    appendMessageToUI('ai', data.response);
                } else {
                    appendMessageToUI('ai', "_Error: Received empty response._");
                }

            } catch (error) {
                console.error("Error:", error);
                let errorMsg = `**Connection Failed**: ${error.message}.`;
                if (window.location.protocol === 'https:' && apiBaseUrl.startsWith('http:')) {
                    errorMsg += `\n\n*Note: Mixed Content blocking (HTTPS -> HTTP) detected. The proxies also failed to retrieve data.*`;
                }
                appendMessageToUI('ai', errorMsg);
            } finally {
                loading.classList.add('hidden');
                document.getElementById('sendBtn').disabled = false;
                setTimeout(() => document.getElementById('userPrompt').focus(), 100);
            }
        }
    </script>
</body>
</html>
